/*
 * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one
 * or more contributor license agreements. Licensed under the Elastic License
 * 2.0; you may not use this file except in compliance with the Elastic License
 * 2.0.
 */

import React, { useCallback, useMemo, useState } from 'react';
import { EuiButton, EuiFlexGroup, EuiFlexItem, useEuiTheme } from '@elastic/eui';
import { css } from '@emotion/react';
import type { AttachmentRenderProps } from '@kbn/agent-builder-browser/attachments';
import type { DashboardAttachmentData, AttachmentPanel } from '@kbn/dashboard-agent-common';
import { isGenericAttachmentPanel, isLensAttachmentPanel } from '@kbn/dashboard-agent-common';
import type { DashboardAttachment } from '@kbn/dashboard-agent-common/types';
import type { DashboardState } from '@kbn/dashboard-plugin/common';
import { DashboardRenderer } from '@kbn/dashboard-plugin/public';
import type { DashboardApi, DashboardCreationOptions } from '@kbn/dashboard-plugin/public';
import type { DashboardPanel } from '@kbn/dashboard-plugin/server';
import { MARKDOWN_EMBEDDABLE_TYPE } from '@kbn/dashboard-markdown/public';
import { i18n } from '@kbn/i18n';
import {
  LensConfigBuilder,
  type LensApiSchemaType,
  type LensAttributes,
} from '@kbn/lens-embeddable-utils/config_builder';
import type { LensSerializedAPIConfig } from '@kbn/lens-common-2';

const DASHBOARD_GRID_COLUMN_COUNT = 48;
const DEFAULT_PANEL_HEIGHT = 9;
const SMALL_PANEL_WIDTH = 12;
const LARGE_PANEL_WIDTH = 24;
const MARKDOWN_PANEL_WIDTH = 48;
const MARKDOWN_MIN_HEIGHT = 6;
const MARKDOWN_MAX_HEIGHT = 9;
const SMALL_CHART_TYPES = new Set(['metric', 'legacy_metric', 'gauge']);

export const PANEL_LAYOUT = {
  defaultPanelHeight: DEFAULT_PANEL_HEIGHT,
  smallPanelWidth: SMALL_PANEL_WIDTH,
  largePanelWidth: LARGE_PANEL_WIDTH,
  markdownPanelWidth: MARKDOWN_PANEL_WIDTH,
  markdownMinHeight: MARKDOWN_MIN_HEIGHT,
  markdownMaxHeight: MARKDOWN_MAX_HEIGHT,
  smallChartTypes: SMALL_CHART_TYPES,
  dashboardGridColumnCount: DASHBOARD_GRID_COLUMN_COUNT,
};

export const getLensPanelWidthFromAttributes = (lensAttributes: LensAttributes): number => {
  const visType = lensAttributes.visualizationType;
  const isSmallChart =
    visType === 'lnsMetric' || visType === 'lnsLegacyMetric' || visType === 'lnsGauge';
  return isSmallChart ? SMALL_PANEL_WIDTH : LARGE_PANEL_WIDTH;
};

export const getPanelWidth = (chartType: string, layout = PANEL_LAYOUT): number => {
  return layout.smallChartTypes.has(chartType) ? layout.smallPanelWidth : layout.largePanelWidth;
};

export const calculateMarkdownPanelHeight = (content: string, layout = PANEL_LAYOUT): number => {
  const lineCount = content.split('\n').length;
  const estimatedHeight = lineCount + 2;
  return Math.max(layout.markdownMinHeight, Math.min(layout.markdownMaxHeight, estimatedHeight));
};

export const buildLensPanelFromApi = (
  config: LensApiSchemaType,
  grid: DashboardPanel['grid'],
  uid?: string
): DashboardPanel => {
  const lensAttributes: LensAttributes = new LensConfigBuilder().fromAPIFormat(config);

  const lensConfig: LensSerializedAPIConfig = {
    title: lensAttributes.title ?? config.title ?? 'Generated panel',
    attributes: lensAttributes,
  };

  return {
    type: 'lens',
    grid,
    config: lensConfig,
    uid,
  };
};

export interface BuildPanelFromRawConfigOptions {
  embeddableType: string;
  rawConfig: Record<string, unknown>;
  title: string | undefined;
  position: { currentX: number; currentY: number };
  layout?: typeof PANEL_LAYOUT;
  uid?: string;
  getLensPanelWidth?: (lensAttributes: LensAttributes) => number;
}

export const buildPanelFromRawConfig = ({
  layout = PANEL_LAYOUT,
  embeddableType,
  rawConfig,
  title,
  position,
  uid,
  getLensPanelWidth,
}: BuildPanelFromRawConfigOptions): DashboardPanel | null => {
  const { currentX, currentY } = position;

  if (embeddableType === 'lens') {
    const lensAttributes = rawConfig as LensAttributes;
    const width = getLensPanelWidth ? getLensPanelWidth(lensAttributes) : layout.largePanelWidth;

    let x = currentX;
    let y = currentY;
    if (x + width > layout.dashboardGridColumnCount) {
      x = 0;
      y += layout.defaultPanelHeight;
    }

    const lensConfig: LensSerializedAPIConfig = {
      title: title ?? lensAttributes.title ?? 'Panel',
      attributes: lensAttributes,
    };

    return {
      type: 'lens',
      grid: { x, y, w: width, h: layout.defaultPanelHeight },
      config: lensConfig,
      uid,
    };
  }

  if (embeddableType === MARKDOWN_EMBEDDABLE_TYPE) {
    const content = (rawConfig as { content?: string }).content ?? '';
    const height = calculateMarkdownPanelHeight(content, layout);
    const width = layout.markdownPanelWidth;

    let x = currentX;
    let y = currentY;
    if (x + width > layout.dashboardGridColumnCount) {
      x = 0;
      y += layout.defaultPanelHeight;
    }

    return {
      type: MARKDOWN_EMBEDDABLE_TYPE,
      grid: { x, y, w: width, h: height },
      config: { content },
      uid,
    };
  }

  const width = layout.largePanelWidth;
  let x = currentX;
  let y = currentY;
  if (x + width > layout.dashboardGridColumnCount) {
    x = 0;
    y += layout.defaultPanelHeight;
  }

  return {
    type: embeddableType,
    grid: { x, y, w: width, h: layout.defaultPanelHeight },
    config: rawConfig,
    uid,
  };
};

export const normalizePanels = (
  panels: AttachmentPanel[],
  yOffset: number = 0,
  layout: typeof PANEL_LAYOUT = PANEL_LAYOUT,
  includePanelIdAsUid: boolean = true,
  getLensPanelWidth: (lensAttributes: LensAttributes) => number = getLensPanelWidthFromAttributes
): DashboardPanel[] => {
  const normalizedLayout = layout ?? PANEL_LAYOUT;
  const panelList = panels ?? [];
  const dashboardPanels: DashboardPanel[] = [];
  let currentX = 0;
  let currentY = yOffset;

  for (const panel of panelList) {
    let dashboardPanel: DashboardPanel | null = null;

    if (isLensAttachmentPanel(panel)) {
      const config = panel.visualization as LensApiSchemaType;
      const width = getPanelWidth(config.type, normalizedLayout);

      if (currentX + width > normalizedLayout.dashboardGridColumnCount) {
        currentX = 0;
        currentY += normalizedLayout.defaultPanelHeight;
      }

      dashboardPanel = buildLensPanelFromApi(
        config,
        {
          x: currentX,
          y: currentY,
          w: width,
          h: normalizedLayout.defaultPanelHeight,
        },
        includePanelIdAsUid ? panel.panelId : undefined
      );
      currentX += width;
    } else if (isGenericAttachmentPanel(panel)) {
      dashboardPanel = buildPanelFromRawConfig({
        embeddableType: panel.type,
        rawConfig: panel.rawConfig,
        title: panel.title,
        position: {
          currentX,
          currentY,
        },
        layout: normalizedLayout,
        uid: includePanelIdAsUid ? panel.panelId : undefined,
        getLensPanelWidth,
      });

      if (dashboardPanel) {
        currentX += dashboardPanel.grid.w;
        if (currentX >= normalizedLayout.dashboardGridColumnCount) {
          currentX = 0;
          currentY += normalizedLayout.defaultPanelHeight;
        }
      }
    }

    if (dashboardPanel) {
      dashboardPanels.push(dashboardPanel);
    }
  }

  return dashboardPanels;
};

export interface DashboardCanvasInitialInput {
  timeRange: {
    from: string;
    to: string;
  };
  viewMode: 'view';
  panels: DashboardState['panels'];
  title?: string;
  description?: string;
}

export const createDashboardRendererInitialInput = (
  data: DashboardAttachmentData
): DashboardCanvasInitialInput => ({
  timeRange: { from: 'now-24h', to: 'now' },
  viewMode: 'view',
  panels: normalizePanels(data.panels ?? []) as DashboardState['panels'],
  title: data.title,
  description: data.description,
});

export const getDashboardRendererCreationOptions = async ({
  savedObjectId,
  initialDashboardInput,
}: {
  savedObjectId?: string;
  initialDashboardInput: DashboardCanvasInitialInput;
}): Promise<DashboardCreationOptions> => {
  if (savedObjectId) {
    return {
      getInitialInput: () => ({
        viewMode: 'view',
      }),
    };
  }

  return {
    getInitialInput: () => ({
      ...initialDashboardInput,
    }),
  };
};

export const saveDashboardFromApi = async (dashboardApi: DashboardApi): Promise<void> => {
  if (dashboardApi.savedObjectId$.value) {
    await dashboardApi.runQuickSave();
    return;
  }

  await dashboardApi.runInteractiveSave();
};

const getDashboardCanvasContentStyles = ({
  euiTheme,
}: {
  euiTheme: ReturnType<typeof useEuiTheme>['euiTheme'];
}) => ({
  root: css({
    display: 'flex',
    flexDirection: 'column',
    height: '100%',
    minHeight: 400,
    '& .dashboardViewport': {
      minHeight: 0,
    },
    '& .embPanel__hoverActions': {
      display: 'none !important',
    },
  }),
  actions: css({
    padding: euiTheme.size.m,
  }),
  renderer: css({
    flex: 1,
    minHeight: 0,
    display: 'flex',
  }),
});

export const DashboardCanvasContent = ({
  attachment,
}: AttachmentRenderProps<DashboardAttachment>) => {
  const { euiTheme } = useEuiTheme();
  const data = attachment.data;
  const [dashboardApi, setDashboardApi] = useState<DashboardApi | undefined>();
  const [isSaveInProgress, setIsSaveInProgress] = useState(false);
  const styles = useMemo(() => getDashboardCanvasContentStyles({ euiTheme }), [euiTheme]);

  const initialDashboardInput = useMemo(() => createDashboardRendererInitialInput(data), [data]);

  const getCreationOptions = useCallback(
    () =>
      getDashboardRendererCreationOptions({
        savedObjectId: data.savedObjectId,
        initialDashboardInput,
      }),
    [data.savedObjectId, initialDashboardInput]
  );

  const handleSave = useCallback(async () => {
    if (!dashboardApi || isSaveInProgress) {
      return;
    }

    setIsSaveInProgress(true);
    try {
      await saveDashboardFromApi(dashboardApi);
    } finally {
      setIsSaveInProgress(false);
    }
  }, [dashboardApi, isSaveInProgress]);

  return (
    <div css={styles.root}>
      <div css={styles.actions}>
        <EuiFlexGroup justifyContent="flexEnd" gutterSize="s" responsive={false}>
          <EuiFlexItem grow={false}>
            <EuiButton
              fill
              size="s"
              iconType="save"
              onClick={handleSave}
              isLoading={isSaveInProgress}
              disabled={!dashboardApi || isSaveInProgress}
              data-test-subj="dashboardCanvasSaveButton"
            >
              {i18n.translate('xpack.dashboardAgent.attachments.dashboard.canvasSaveActionLabel', {
                defaultMessage: 'Save dashboard',
              })}
            </EuiButton>
          </EuiFlexItem>
        </EuiFlexGroup>
      </div>
      <div css={styles.renderer}>
        <DashboardRenderer
          getCreationOptions={getCreationOptions}
          showPlainSpinner
          savedObjectId={data.savedObjectId}
          onApiAvailable={(api) => {
            api.setViewMode('view');
            setDashboardApi(api);
          }}
        />
      </div>
    </div>
  );
};
